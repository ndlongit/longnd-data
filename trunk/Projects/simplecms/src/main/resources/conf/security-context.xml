<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:security="http://www.springframework.org/schema/security"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans 
            http://www.springframework.org/schema/beans/spring-beans-2.0.xsd 
	        http://www.springframework.org/schema/security 
            http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">
    
    <security:global-method-security secured-annotations="enabled"/>
    
    <security:authentication-manager alias="authenticationManager" />
    
    <security:authentication-provider user-service-ref="userService">
        <security:password-encoder hash="md5">
            <security:salt-source user-property="username" />
        </security:password-encoder>
    </security:authentication-provider>
    
    <bean id="filterChainProxy" class="org.springframework.security.util.FilterChainProxy">
        <security:filter-chain-map path-type="ant">
            <security:filter-chain pattern="/asset/**" filters="none" />
            <security:filter-chain pattern="/signin**" filters="none" />
            <security:filter-chain pattern="/signout**" filters="none" />
            <security:filter-chain pattern="/signup**" filters="none" />
            <security:filter-chain pattern="/**" filters="httpSessionContextIntegrationFilter,authenticationProcessingFilter,logoutFilter,exceptionTranslationFilter,filterInvocationInterceptor" />
        </security:filter-chain-map>
    </bean>
    
    <bean id="httpSessionContextIntegrationFilter"
          class="org.springframework.security.context.HttpSessionContextIntegrationFilter">
        <property name="contextClass" value="org.springframework.security.context.SecurityContextImpl"/>
        <property name="forceEagerSessionCreation" value="false"/>
        <property name="allowSessionCreation" value="true"/>
    </bean>
    
    <bean id="authenticationProcessingFilter"
          class="org.springframework.security.ui.webapp.AuthenticationProcessingFilter">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="authenticationFailureUrl" value="/signin?failed=true"/>
        <property name="defaultTargetUrl" value="/"/>
        <property name="filterProcessesUrl" value="/j_login"/>
        <property name="usernameParameter" value="username" />
        <property name="passwordParameter" value="password" />
        <property name="targetUrlResolver" ref="targetUrlResolver"/>
    </bean>
    
    <bean id="logoutFilter" class="org.springframework.security.ui.logout.LogoutFilter">
        <constructor-arg index="0" value="/"/>
        <constructor-arg index="1">
            <list>
                <ref local="securityContextLogoutHandler"/>
            </list>
        </constructor-arg>
        <property name="filterProcessesUrl" value="/j_logout"/>
    </bean>
    
    <bean id="exceptionTranslationFilter" class="org.springframework.security.ui.ExceptionTranslationFilter">
        <property name="authenticationEntryPoint" ref="authenticationEntryPoint"/>
    </bean>
    
    <bean id="filterInvocationInterceptor" class="org.springframework.security.intercept.web.FilterSecurityInterceptor">
        <property name="authenticationManager" ref="authenticationManager" />
        <property name="accessDecisionManager">
            <ref local="tinyCMSAccessDecisionManager" />
        </property>
        <property name="objectDefinitionSource">
            <value>
                CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
                PATTERN_TYPE_APACHE_ANT
            </value>
        </property>
    </bean>

    <bean id="authenticationEntryPoint"
          class="org.springframework.security.ui.webapp.AuthenticationProcessingFilterEntryPoint">
        <property name="loginFormUrl" value="/signin"/>
        <property name="forceHttps" value="false"/>
    </bean>
    
    <bean id="securityContextLogoutHandler" class="org.springframework.security.ui.logout.SecurityContextLogoutHandler"/>
    
    <bean id="targetUrlResolver" class="vn.pyco.tinycms.web.services.internal.AppTargetUrlResolver"/>
    
    <bean id="tinyCMSAccessDecisionManager" class="org.springframework.security.vote.AffirmativeBased">
        <property name="allowIfAllAbstainDecisions" value="false" />
        <property name="decisionVoters">
            <list>
                <ref local="FoRoleVoter" />
                <ref local="SaRoleVoter" />
                <ref local="BoRoleVoter" />
            </list>
        </property>
    </bean>
    
    <bean id="FoRoleVoter" class="vn.pyco.tinycms.web.services.internal.FoRoleVoter" />
    <bean id="SaRoleVoter" class="vn.pyco.tinycms.web.services.internal.SaRoleVoter" />
    <bean id="BoRoleVoter" class="vn.pyco.tinycms.web.services.internal.BoRoleVoter" />
</beans>
